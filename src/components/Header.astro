---
import { Menu, X, Globe, ChevronDown, Camera, Shield, DoorOpen, Server, Wrench, Wifi, Banknote, Printer, ScanLine, Search, FileText, Network, Lock, Code, Monitor, Headphones, Cloud } from 'lucide-astro';
import { getLocale, useTranslations, getLocalizedPath, languages } from '../i18n/utils';

const locale = getLocale(Astro.url);
const t = useTranslations(locale);

const navLinks = [
  { href: getLocalizedPath('/', locale), label: t('nav.home') },
  { href: getLocalizedPath('/services', locale), label: t('nav.services'), hasDropdown: true },
  { href: getLocalizedPath('/about', locale), label: t('nav.about') },
  { href: getLocalizedPath('/contact', locale), label: t('nav.contact') },
];

const serviceCategories = [
  {
    title: 'Consulting & Audit',
    items: [
      { label: 'Needs Assessment', href: getLocalizedPath('/services', locale) },
      { label: 'Specifications', href: getLocalizedPath('/services', locale) },
      { label: 'IT Roadmaps', href: getLocalizedPath('/services', locale) },
      { label: 'Project Management', href: getLocalizedPath('/services', locale) }
    ]
  },
  {
    title: 'IT Infrastructure',
    items: [
      { label: 'LAN/WAN/WLAN Networks', href: getLocalizedPath('/services/servers', locale) },
      { label: 'Storage & Remote Access', href: getLocalizedPath('/services/servers', locale) },
      { label: 'Backup & Recovery', href: getLocalizedPath('/services/servers', locale) },
      { label: 'Virtualization', href: getLocalizedPath('/services/servers', locale) },
      { label: 'Collaboration Solutions', href: getLocalizedPath('/services/servers', locale) }
    ]
  },
  {
    title: 'Cybersecurity',
    items: [
      { label: 'Firewall & Protection', href: getLocalizedPath('/services', locale) },
      { label: 'Antivirus & Anti-malware', href: getLocalizedPath('/services', locale) },
      { label: 'MFA Authentication', href: getLocalizedPath('/services', locale) },
      { label: 'Security Audits', href: getLocalizedPath('/services', locale) },
      { label: 'Penetration Testing', href: getLocalizedPath('/services', locale) }
    ]
  },
  {
    title: 'Electronic Security',
    items: [
      { label: 'Video Surveillance', href: getLocalizedPath('/services/cctv', locale) },
      { label: 'Access Control', href: getLocalizedPath('/services/access', locale) },
      { label: 'Intrusion Detection', href: getLocalizedPath('/services/alarm', locale) },
      { label: 'Alarm Systems', href: getLocalizedPath('/services/alarm', locale) },
      { label: 'X-Ray Inspection', href: getLocalizedPath('/services/xray-scanner', locale) }
    ]
  },
  {
    title: 'Equipment & Services',
    items: [
      { label: 'IT Hardware', href: getLocalizedPath('/services', locale) },
      { label: 'Managed Services', href: getLocalizedPath('/services/maintenance', locale) },
      { label: '24/7 Support', href: getLocalizedPath('/services/maintenance', locale) },
      { label: 'Cash Handling', href: getLocalizedPath('/services/cash-handling', locale) },
      { label: 'Printer Leasing', href: getLocalizedPath('/services/printing', locale) }
    ]
  },
  {
    title: 'Telecommunications',
    items: [
      { label: 'VoIP Solutions', href: getLocalizedPath('/services/telecom', locale) },
      { label: 'PBX Systems', href: getLocalizedPath('/services/telecom', locale) },
      { label: 'Video Conferencing', href: getLocalizedPath('/services/telecom', locale) },
      { label: 'Network Cabling', href: getLocalizedPath('/services/telecom', locale) },
      { label: 'Fiber Optics', href: getLocalizedPath('/services/telecom', locale) }
    ]
  }
];

const currentPath = Astro.url.pathname;
const isServicesActive = currentPath.startsWith('/services');
const isHomePage = currentPath === '/' || currentPath === '/es' || currentPath === '/en' || currentPath === '/fr';
const currentLocale = languages.find(lang => lang.code === locale);
---

<header class="fixed top-0 left-0 right-0 z-50 transition-all duration-300" id="main-header">
  <nav id="main-nav" class="transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <!-- Logo -->
        <a href="/" class="flex items-center space-x-3 group">
          <img
            id="logo-light"
            src="/images/Logo-06 (Edited).png"
            alt="OptimuxSolutions"
            class="h-12 w-auto transition-all duration-300 group-hover:scale-105"
          />
          <img
            id="logo-dark"
            src="/images/Logo-05.png"
            alt="OptimuxSolutions"
            class="h-12 w-auto transition-all duration-300 group-hover:scale-105 hidden"
          />
          <div class="hidden sm:flex flex-col items-center">
            <span id="logo-text" class="text-2xl tracking-tight leading-none transition-colors duration-300" style="font-family: 'Exo', sans-serif; font-weight: 900;">OPTIMUX</span>
            <span id="logo-subtext" class="text-[11px] tracking-[0.22em] mt-0.5 transition-colors duration-300 text-center" style="font-family: 'BankGothic', sans-serif; font-weight: 300;">SOLUTIONS</span>
          </div>
        </a>

        <!-- Desktop Navigation -->
        <div class="hidden lg:flex items-center space-x-8">
          {navLinks.map((link) => (
            <div class="relative group">
              {link.hasDropdown ? (
                <>
                  <button
                    type="button"
                    class="nav-link flex items-center space-x-1 font-semibold transition-colors"
                    id="services-mega-btn"
                  >
                    <span>{link.label}</span>
                    <ChevronDown class="w-4 h-4 transition-transform" id="services-mega-chevron" />
                  </button>
                  <!-- Mega Menu -->
                  <div
                    class="absolute left-1/2 transform -translate-x-1/2 top-full pt-4 w-screen max-w-5xl hidden opacity-0 transition-all duration-300"
                    id="mega-menu"
                  >
                    <div class="bg-white rounded-2xl shadow-2xl p-8 border border-slate-100">
                      <div class="grid grid-cols-3 gap-8">
                        {serviceCategories.map((category) => (
                          <div class="space-y-3">
                            <h3 class="font-bold text-slate-900 text-lg border-b-2 border-blue-600 pb-2 mb-3">{category.title}</h3>
                            <ul class="space-y-2">
                              {category.items.map((item) => (
                                <li>
                                  <a
                                    href={item.href}
                                    class="text-sm text-slate-600 hover:text-blue-700 hover:translate-x-1 transition-all flex items-center space-x-2 group/item"
                                  >
                                    <span class="w-1.5 h-1.5 bg-blue-600 rounded-full group-hover/item:w-2 group-hover/item:h-2 transition-all"></span>
                                    <span>{item.label}</span>
                                  </a>
                                </li>
                              ))}
                            </ul>
                          </div>
                        ))}
                      </div>
                      <!-- View All Services Link -->
                      <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                        <a
                          href={getLocalizedPath('/services', locale)}
                          class="inline-flex items-center gap-2 text-blue-700 font-semibold hover:text-blue-800 transition-colors"
                        >
                          {t('common.viewAll')} {t('nav.services')}
                          <ChevronDown class="w-4 h-4 rotate-[-90deg]" />
                        </a>
                      </div>
                    </div>
                  </div>
                </>
              ) : (
                <a
                  href={link.href}
                  class="nav-link font-semibold transition-colors"
                >
                  {link.label}
                </a>
              )}
            </div>
          ))}

          <!-- Language Switcher -->
          <div class="relative group">
            <button
              type="button"
              class="nav-link flex items-center space-x-2 font-semibold transition-colors"
              id="lang-switcher-btn"
            >
              <Globe class="w-4 h-4" />
              <span>{currentLocale?.flag}</span>
              <ChevronDown class="w-3 h-3" />
            </button>
            <div class="absolute right-0 top-full pt-2 w-40 hidden" id="lang-menu">
              <div class="bg-white rounded-lg shadow-xl p-2 border border-slate-100">
                {languages.map((lang) => (
                  <a
                    href={getLocalizedPath(currentPath.replace(/^\/(en|es|fr)/, ''), lang.code)}
                    class:list={[
                      'block px-4 py-2 rounded-md text-sm transition-colors',
                      lang.code === locale
                        ? 'bg-blue-50 text-blue-700 font-semibold'
                        : 'text-slate-700 hover:bg-slate-50'
                    ]}
                  >
                    <span class="mr-2">{lang.flag}</span>
                    {lang.label}
                  </a>
                ))}
              </div>
            </div>
          </div>

          <!-- CTA Button -->
          <a
            href={getLocalizedPath('/contact', locale)}
            id="cta-btn"
            class="px-6 py-2.5 rounded-lg font-semibold transition-all shadow-lg hover:shadow-xl"
          >
            {t('nav.getQuote')}
          </a>
        </div>

        <!-- Mobile Menu Button -->
        <button
          type="button"
          class="lg:hidden p-2 rounded-lg transition-colors"
          id="mobile-menu-btn"
          aria-label="Open menu"
        >
          <Menu class="h-6 w-6" id="menu-icon" />
          <X class="h-6 w-6 hidden" id="close-icon" />
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div class="lg:hidden bg-white border-t border-slate-200 shadow-lg hidden" id="mobile-menu">
      <div class="px-4 py-6 space-y-4 max-h-[80vh] overflow-y-auto">
        <!-- Home -->
        <a
          href={getLocalizedPath('/', locale)}
          class:list={[
            'block font-semibold py-2',
            currentPath === '/' || currentPath === `/${locale}`
              ? 'text-blue-700'
              : 'text-slate-700 hover:text-blue-700'
          ]}
        >
          {t('nav.home')}
        </a>

        <!-- Services Accordion -->
        <div>
          <button
            type="button"
            class:list={[
              'flex items-center justify-between w-full font-semibold py-2',
              isServicesActive ? 'text-blue-700' : 'text-slate-700'
            ]}
            id="mobile-services-btn"
          >
            <span>{t('nav.services')}</span>
            <ChevronDown class="w-4 h-4 transition-transform" id="mobile-services-chevron" />
          </button>
          <div class="hidden mt-4 space-y-4" id="mobile-services-menu">
            {serviceCategories.map((category) => (
              <div>
                <h4 class="font-bold text-slate-900 text-sm border-b border-blue-600 pb-1 mb-2">{category.title}</h4>
                <ul class="space-y-1 ml-2">
                  {category.items.map((item) => (
                    <li>
                      <a
                        href={item.href}
                        class="text-sm text-slate-600 hover:text-blue-700 flex items-center space-x-2 py-1"
                      >
                        <span class="w-1 h-1 bg-blue-600 rounded-full"></span>
                        <span>{item.label}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
            <a
              href={getLocalizedPath('/services', locale)}
              class="block text-blue-700 font-semibold text-sm mt-4"
            >
              {t('common.viewAll')} {t('nav.services')} â†’
            </a>
          </div>
        </div>

        <!-- About -->
        <a
          href={getLocalizedPath('/about', locale)}
          class:list={[
            'block font-semibold py-2',
            currentPath.includes('/about')
              ? 'text-blue-700'
              : 'text-slate-700 hover:text-blue-700'
          ]}
        >
          {t('nav.about')}
        </a>

        <!-- Contact -->
        <a
          href={getLocalizedPath('/contact', locale)}
          class:list={[
            'block font-semibold py-2',
            currentPath.includes('/contact')
              ? 'text-blue-700'
              : 'text-slate-700 hover:text-blue-700'
          ]}
        >
          {t('nav.contact')}
        </a>

        <!-- Language Switcher Mobile -->
        <div class="pt-4 border-t border-slate-200">
          <div class="flex items-center space-x-2 mb-2 text-sm text-slate-600">
            <Globe class="w-4 h-4" />
            <span>Idioma / Language</span>
          </div>
          <div class="flex gap-2">
            {languages.map((lang) => (
              <a
                href={getLocalizedPath(currentPath.replace(/^\/(en|es|fr)/, ''), lang.code)}
                class:list={[
                  'flex-1 px-3 py-2 rounded-md text-sm text-center transition-colors',
                  lang.code === locale
                    ? 'bg-blue-600 text-white font-semibold'
                    : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                ]}
              >
                {lang.flag}
              </a>
            ))}
          </div>
        </div>

        <!-- CTA Button -->
        <a
          href={getLocalizedPath('/contact', locale)}
          class="block w-full bg-gradient-to-r from-blue-700 to-blue-900 hover:from-blue-800 hover:to-blue-950 text-white px-6 py-3 rounded-lg font-semibold text-center mt-4"
        >
          {t('nav.getQuote')}
        </a>
      </div>
    </div>
  </nav>
</header>

<!-- Spacer to prevent content from going under fixed header (only on non-home pages) -->
<div id="header-spacer" class="h-20"></div>

<script define:vars={{ isHomePage }}>
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');
  const servicesMegaBtn = document.getElementById('services-mega-btn');
  const megaMenu = document.getElementById('mega-menu');
  const servicesMegaChevron = document.getElementById('services-mega-chevron');
  const mobileServicesBtn = document.getElementById('mobile-services-btn');
  const mobileServicesMenu = document.getElementById('mobile-services-menu');
  const mobileServicesChevron = document.getElementById('mobile-services-chevron');
  const langSwitcherBtn = document.getElementById('lang-switcher-btn');
  const langMenu = document.getElementById('lang-menu');
  const mainNav = document.getElementById('main-nav');
  const logoText = document.getElementById('logo-text');
  const logoSubtext = document.getElementById('logo-subtext');
  const logoLight = document.getElementById('logo-light');
  const logoDark = document.getElementById('logo-dark');
  const ctaBtn = document.getElementById('cta-btn');
  const headerSpacer = document.getElementById('header-spacer');
  const navLinks = document.querySelectorAll('.nav-link');

  // Hide spacer on home page
  if (isHomePage && headerSpacer) {
    headerSpacer.style.display = 'none';
  }

  // Set initial state based on page
  function setTransparentNav() {
    mainNav?.classList.remove('bg-white', 'shadow-lg');
    mainNav?.classList.add('bg-transparent');
    logoText?.classList.remove('text-slate-900');
    logoText?.classList.add('text-white');
    logoSubtext?.classList.remove('text-slate-600');
    logoSubtext?.classList.add('text-white/70');
    // Show light logo (for dark background)
    logoLight?.classList.remove('hidden');
    logoDark?.classList.add('hidden');
    ctaBtn?.classList.remove('bg-gradient-to-r', 'from-blue-700', 'to-blue-900', 'text-white');
    ctaBtn?.classList.add('bg-white', 'text-blue-900', 'hover:bg-blue-50');
    navLinks.forEach(link => {
      link.classList.remove('text-slate-700');
      link.classList.add('text-white', 'hover:text-blue-200');
    });
    mobileMenuBtn?.classList.remove('text-slate-700');
    mobileMenuBtn?.classList.add('text-white');
  }

  function setSolidNav() {
    mainNav?.classList.remove('bg-transparent');
    mainNav?.classList.add('bg-white', 'shadow-lg');
    logoText?.classList.remove('text-white');
    logoText?.classList.add('text-slate-900');
    logoSubtext?.classList.remove('text-white/70');
    logoSubtext?.classList.add('text-slate-600');
    // Show dark logo (for light background)
    logoLight?.classList.add('hidden');
    logoDark?.classList.remove('hidden');
    ctaBtn?.classList.remove('bg-white', 'text-blue-900', 'hover:bg-blue-50');
    ctaBtn?.classList.add('bg-gradient-to-r', 'from-blue-700', 'to-blue-900', 'text-white');
    navLinks.forEach(link => {
      link.classList.remove('text-white', 'hover:text-blue-200');
      link.classList.add('text-slate-700', 'hover:text-blue-700');
    });
    mobileMenuBtn?.classList.remove('text-white');
    mobileMenuBtn?.classList.add('text-slate-700');
  }

  // Initialize nav state
  if (isHomePage) {
    setTransparentNav();
  } else {
    setSolidNav();
  }

  // Mobile menu toggle
  mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
    menuIcon?.classList.toggle('hidden');
    closeIcon?.classList.toggle('hidden');
  });

  // Desktop Mega Menu hover
  let megaMenuTimeout;

  servicesMegaBtn?.addEventListener('mouseenter', () => {
    clearTimeout(megaMenuTimeout);
    megaMenu?.classList.remove('hidden');
    setTimeout(() => {
      megaMenu?.classList.remove('opacity-0');
      servicesMegaChevron?.classList.add('rotate-180');
    }, 10);
  });

  servicesMegaBtn?.addEventListener('mouseleave', () => {
    megaMenuTimeout = setTimeout(() => {
      closeMegaMenu();
    }, 100);
  });

  megaMenu?.addEventListener('mouseenter', () => {
    clearTimeout(megaMenuTimeout);
  });

  megaMenu?.addEventListener('mouseleave', () => {
    closeMegaMenu();
  });

  function closeMegaMenu() {
    megaMenu?.classList.add('opacity-0');
    servicesMegaChevron?.classList.remove('rotate-180');
    setTimeout(() => {
      megaMenu?.classList.add('hidden');
    }, 300);
  }

  // Mobile Services Accordion
  mobileServicesBtn?.addEventListener('click', () => {
    mobileServicesMenu?.classList.toggle('hidden');
    mobileServicesChevron?.classList.toggle('rotate-180');
  });

  // Language Switcher
  let langMenuTimeout;

  langSwitcherBtn?.addEventListener('mouseenter', () => {
    clearTimeout(langMenuTimeout);
    langMenu?.classList.remove('hidden');
  });

  langSwitcherBtn?.addEventListener('mouseleave', () => {
    langMenuTimeout = setTimeout(() => {
      langMenu?.classList.add('hidden');
    }, 200);
  });

  langMenu?.addEventListener('mouseenter', () => {
    clearTimeout(langMenuTimeout);
  });

  langMenu?.addEventListener('mouseleave', () => {
    langMenu?.classList.add('hidden');
  });

  // Scroll effect for header (only on home page)
  if (isHomePage) {
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        setSolidNav();
      } else {
        setTransparentNav();
      }
    });
  }
</script>
